<?php
	
	if( !class_exists('UserController') ) {
		include(dirname(__FILE__) . '/../UserController.php');
		$UserController = new UserController;
	}
		$PDODB = Utility::getPDO();
			
			// Check if email already exists in DB
			$query = $PDODB->prepare("SELECT id
									  FROM users
									  WHERE email = :email;");
			$query->bindParam(':email', $email);
			if(!$query->execute()) {
				Utility::throwError($query->errorInfo());
				return false;
			}
			
			// If it exists, fail
			if( count($query->fetchAll()) )
				return false;
				
		// Get the last id from the above query
			$user_id = $PDODB->lastInsertId();
			$resetkey = Utility::getrandomhash();
		
		
		
		
		// Now store their key
		$query = $PDODB->prepare("INSERT INTO user_resetkey
									 (
									user_id
									, resetkey
									 )
									 VALUES
									 (
									:user_id
									, :resetkey
									 )");
						 
	
	
	?>	
